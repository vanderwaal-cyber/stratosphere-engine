<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratosphere Lead Engine</title>

    <!-- Tailwinc CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        accent: '#06b6d4',
                        background: '#09090b',
                        surface: '#18181b',
                        surfaceHighlight: '#27272a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #09090b;
            color: #fff;
        }

        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-card {
            background: rgba(39, 39, 42, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #09090b;
        }

        ::-webkit-scrollbar-thumb {
            background: #27272a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3f3f46;
        }

        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body
    class="min-h-screen bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-fixed text-gray-200 selection:bg-primary selection:text-white">

    <!-- Top Glow -->
    <div class="fixed top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-accent to-primary opacity-50 blur-sm">
    </div>

    <!-- Cover Image -->
    <div class="relative w-full h-48 md:h-64 bg-surfaceHighlight overflow-hidden">
        <img src="/assets/cover.jpg" class="w-full h-full object-cover opacity-60" alt="Cover"
            onerror="this.style.display='none'">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-background/20 to-background"></div>
    </div>

    <div class="max-w-7xl mx-auto px-6 relative z-10 -mt-20">

        <!-- HEADER (Profile Style) -->
        <header class="flex flex-col md:flex-row items-end justify-between gap-6 mb-12">
            <div class="flex items-end gap-6">
                <!-- PFP -->
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-primary to-accent rounded-2xl blur opacity-30 group-hover:opacity-70 transition duration-500">
                    </div>
                    <img id="logo-img" src="/assets/brand_logo.jpg" alt="Stratosphere"
                        class="relative w-32 h-32 rounded-2xl border-4 border-background shadow-2xl object-cover bg-background">
                    <div class="absolute bottom-2 right-2 w-4 h-4 rounded-full bg-emerald-500 border-2 border-background animate-pulse"
                        title="System Active"></div>
                </div>

                <!-- Info -->
                <div class="pb-2">
                    <h1 class="text-4xl font-bold text-white tracking-tight mb-1">Stratosphere <span
                            class="text-primary font-light">Lead Engine</span></h1>
                    <div class="flex items-center gap-3 text-sm text-gray-400">
                        <span
                            class="px-2 py-0.5 rounded text-xs font-medium bg-surfaceHighlight border border-white/5 text-gray-300">v2.0
                            Pro</span>
                        <span>•</span>
                        <p id="status-text" class="font-medium text-emerald-400">System Active</p>
                        <span>•</span>
                        <span id="last-updated" class="text-xs text-gray-500">Updated: Just now</span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-3 pb-2">
                <div id="loading-indicator"
                    class="hidden flex items-center gap-3 px-4 py-2 rounded-full bg-surfaceHighlight/50 border border-white/5">
                    <div class="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                    <span id="loading-text" class="text-sm text-gray-300">Scraping...</span>
                </div>

                <button onclick="stopPipeline()" id="btn-stop"
                    class="hidden px-4 py-2 rounded-lg text-sm font-medium text-red-400 hover:text-red-300 hover:bg-red-900/20 transition-colors border border-transparent hover:border-red-900/30">
                    Stop Run
                </button>

                <button id="btn-generate"
                    class="relative group px-6 py-2.5 rounded-lg bg-white text-black font-semibold text-sm shadow-lg shadow-white/5 hover:shadow-primary/20 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden">
                    <span class="relative z-10 flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4 text-primary"></i>
                        Generate Leads
                    </span>
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-gray-100 to-white opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                </button>
            </div>
        </header>

        <!-- STATS GRID -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <!-- Total Discovered -->
            <div class="glass p-6 rounded-xl flex items-start justify-between relative overflow-hidden group">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Total Discovered</p>
                    <h2 id="stat-total"
                        class="text-4xl font-bold text-white group-hover:text-primary transition-colors">0</h2>
                </div>
                <div
                    class="p-3 bg-white/5 rounded-lg border border-white/5 group-hover:border-primary/20 transition-colors">
                    <i data-lucide="database"
                        class="w-6 h-6 text-gray-400 group-hover:text-white transition-colors"></i>
                </div>
            </div>

            <!-- Ready to DM -->
            <div class="glass p-6 rounded-xl flex items-start justify-between relative overflow-hidden group">
                <div>
                    <p class="text-xs font-medium text-emerald-500/80 uppercase tracking-wider mb-1">Ready to DM</p>
                    <h2 id="stat-ready"
                        class="text-4xl font-bold text-white group-hover:text-emerald-400 transition-colors">0</h2>
                </div>
                <div
                    class="p-3 bg-emerald-500/10 rounded-lg border border-emerald-500/20 group-hover:border-emerald-500/40 transition-colors">
                    <i data-lucide="send" class="w-6 h-6 text-emerald-400"></i>
                </div>
            </div>

            <!-- Needs AI -->
            <div class="glass p-6 rounded-xl flex items-start justify-between relative overflow-hidden group">
                <div>
                    <p class="text-xs font-medium text-amber-500/80 uppercase tracking-wider mb-1">Needs AI / Alt</p>
                    <h2 id="stat-alt"
                        class="text-4xl font-bold text-white group-hover:text-amber-400 transition-colors">0</h2>
                </div>
                <div
                    class="p-3 bg-amber-500/10 rounded-lg border border-amber-500/20 group-hover:border-amber-500/40 transition-colors">
                    <i data-lucide="bot" class="w-6 h-6 text-amber-400"></i>
                </div>
            </div>
        </div>

        <!-- MAIN FEED -->
        <div class="glass rounded-2xl border border-white/5 min-h-[600px] flex flex-col">
            <!-- Feed Header & Filters -->
            <div class="p-6 border-b border-white/5 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-semibold text-white">Lead Feed</h3>
                    <!-- Progress Bar -->
                    <div id="progress-container" class="hidden w-32 h-1.5 bg-gray-800 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-primary transition-all duration-500 w-0"></div>
                    </div>
                </div>

                <!-- Segmented Control -->
                <div class="flex p-1 bg-black/40 rounded-lg border border-white/5">
                    <button onclick="setFilter('READY_TO_DM')" id="tab-ready"
                        class="flex-1 px-4 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition-colors">Ready
                        to DM</button>
                    <button onclick="setFilter('NEEDS_ALT_OUTREACH')" id="tab-ai"
                        class="flex-1 px-4 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition-colors">AI
                        Needed</button>
                    <button onclick="setFilter('')" id="tab-all"
                        class="flex-1 px-4 py-1.5 text-sm font-medium rounded-md bg-surfaceHighlight text-white shadow-sm border border-white/10 transition-all">All
                        Leads</button>
                </div>
            </div>

            <!-- Lead List -->
            <div id="lead-list" class="flex-1 p-4 space-y-3 overflow-y-auto max-h-[800px]"></div>

            <!-- Footer -->
            <div class="p-4 border-t border-white/5 text-center text-xs text-gray-600">
                Stratosphere Engine v2.0 • Pro Edition
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const API_URL = window.location.origin;
        let currentFilter = '';
        let pollingInterval = null;
        let isRunning = false;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const logo = document.getElementById('logo-img');
            if (logo) logo.src = '/assets/brand_logo.jpg?v=' + new Date().getTime();
            fetchData();
            startPolling();
            const btn = document.getElementById('btn-generate');
            if (btn) btn.onclick = handleGenerate;
        });

        async function handleGenerate() {
            setLoadingState(true);
            try {
                const res = await fetch(`${API_URL}/api/generate`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'busy') alert("Engine is already running!");
                else {
                    document.getElementById('progress-bar').style.width = '5%';
                    startPolling();
                }
            } catch (e) {
                console.error(e);
                alert("Failed to start engine.");
                setLoadingState(false);
            }
        }

        async function stopPipeline() {
            if (confirm("Stop current run?")) {
                await fetch(`${API_URL}/pipeline/stop`, { method: 'POST' });
                setLoadingState(false);
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            ['tab-ready', 'tab-ai', 'tab-all'].forEach(id => {
                document.getElementById(id).className = "flex-1 px-4 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition-colors";
            });
            const activeId = filter === 'READY_TO_DM' ? 'tab-ready' : (filter === 'NEEDS_ALT_OUTREACH' ? 'tab-ai' : 'tab-all');
            document.getElementById(activeId).className = "flex-1 px-4 py-1.5 text-sm font-medium rounded-md bg-surfaceHighlight text-white shadow-sm border border-white/10 transition-all";
            fetchData();
        }

        async function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(pollStatus, 1000);
        }

        async function pollStatus() {
            try {
                const res = await fetch(`${API_URL}/api/status`);
                const data = await res.json();
                const state = data.state || 'idle';
                const progress = data.progress || 0;

                // Pills
                const dot = document.getElementById('status-dot'); // Note: Added this element check or remove if not in HTML? 
                // Ah, the original HTML used logic in the header.
                const text = document.getElementById('status-text');

                if (state === 'running') {
                    setLoadingState(true, data.current_step);
                    document.getElementById('progress-container').classList.remove('hidden');
                    document.getElementById('progress-bar').style.width = `${progress}%`;
                    if (data.discovered > 0) document.getElementById('stat-total').textContent = data.discovered;

                    text.textContent = "RUNNING: " + (data.current_step || 'Processing');
                    text.className = "text-xs font-medium text-primary uppercase tracking-widest";
                } else if (state === 'done' || state === 'error') {
                    if (isRunning) { isRunning = false; fetchData(); }
                    setLoadingState(false);
                    document.getElementById('progress-container').classList.add('hidden');

                    if (state === 'error') {
                        text.textContent = "ERROR";
                        text.className = "text-xs font-medium text-red-500 uppercase tracking-widest";
                    } else {
                        text.textContent = "SYSTEM ACTIVE";
                        text.className = "font-medium text-emerald-400";
                    }
                } else {
                    text.textContent = "SYSTEM ACTIVE";
                    text.className = "font-medium text-emerald-400";
                }
            } catch (e) { console.error("Poll error", e); }
        }

        async function fetchData() {
            try {
                let url = `${API_URL}/api/leads?limit=100`;
                if (currentFilter) url += `&bucket=${currentFilter}`;
                const [leadsRes, statsRes] = await Promise.all([fetch(url), fetch(`${API_URL}/api/leads/stats`)]);
                const leads = await leadsRes.json();
                const stats = await statsRes.json();
                renderLeads(leads);
                updateStats(stats);
                document.getElementById('last-updated').textContent = "Updated: " + new Date().toLocaleTimeString();
            } catch (e) {
                console.error("Fetch Data Error", e);
                const list = document.getElementById('lead-list');
                list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-red-400 opacity-80"><i data-lucide="alert-triangle" class="w-12 h-12 mb-2"></i><p class="font-medium">Connection Error</p></div>`;
                lucide.createIcons();
            }
        }

        function updateStats(stats) {
            animateValue('stat-total', parseInt(document.getElementById('stat-total').textContent), stats.total_leads || 0, 1000);
            animateValue('stat-ready', parseInt(document.getElementById('stat-ready').textContent), stats.ready_to_dm || 0, 1000);
            animateValue('stat-alt', parseInt(document.getElementById('stat-alt').textContent), stats.needs_alt_outreach || 0, 1000);
        }

        function setLoadingState(loading, text = "Initializing Engine...") {
            const btn = document.getElementById('btn-generate');
            const stopBtn = document.getElementById('btn-stop');
            const indicator = document.getElementById('loading-indicator');
            const loadText = document.getElementById('loading-text');
            isRunning = loading;
            if (loading) {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.remove('hidden');
                indicator.classList.remove('hidden');
                loadText.textContent = text;
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.add('hidden');
                indicator.classList.add('hidden');
            }
        }

        function renderLeads(leads) {
            const list = document.getElementById('lead-list');
            list.innerHTML = '';
            if (!leads || leads.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-gray-500 opacity-60"><i data-lucide="ghost" class="w-16 h-16 mb-4 stroke-[1]"></i><p class="text-lg font-medium">No leads found in this view.</p></div>`;
                lucide.createIcons();
                return;
            }
            leads.forEach((lead, index) => {
                const el = document.createElement('div');
                el.style.animation = `fadeSlideUp 0.5s ease forwards ${index * 0.05}s`;
                el.className = "flex flex-col md:flex-row gap-4 p-5 rounded-xl glass-card items-start md:items-center justify-between opacity-0";

                let badgeClass = "bg-gray-800 text-gray-400 border-gray-700";
                let badgeText = lead.status;
                if (lead.bucket === 'READY_TO_DM') { badgeClass = "bg-emerald-500/10 text-emerald-400 border-emerald-500/20"; badgeText = "READY TO DM"; }
                else if (lead.bucket === 'NEEDS_ALT_OUTREACH') { badgeClass = "bg-amber-500/10 text-amber-400 border-amber-500/20"; badgeText = "NEEDS AI DRAFT"; }

                const funding = lead.funding_info ? `<span class="ml-2 px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300 text-[10px] border border-blue-500/30 font-mono">${lead.funding_info}</span>` : '';

                el.innerHTML = `
                    <div class="flex items-center gap-4 flex-1">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-800 to-gray-900 border border-white/10 flex items-center justify-center shrink-0 shadow-lg">
                            <span class="text-lg font-bold text-gray-400">${lead.project_name.substring(0, 2).toUpperCase()}</span>
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center gap-3 mb-1">
                                <h3 class="text-white font-bold text-lg truncate hover:text-primary transition-colors cursor-pointer">${lead.project_name}</h3>
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold border ${badgeClass}">${badgeText}</span>
                                ${funding}
                            </div>
                            <p class="text-sm text-gray-400 truncate max-w-xl">${lead.description || "No description available."}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                ${lead.twitter_handle ? `<a href="https://x.com/${lead.twitter_handle.replace('@', '')}" target="_blank" class="flex items-center gap-1 hover:text-white transition-colors"><i data-lucide="twitter" class="w-3 h-3"></i> @${lead.twitter_handle.replace('@', '')}</a>` : ''}
                                ${lead.domain ? `<a href="${lead.domain}" target="_blank" class="flex items-center gap-1 hover:text-white transition-colors"><i data-lucide="globe" class="w-3 h-3"></i> Website</a>` : ''}
                                <span class="flex items-center gap-1 text-gray-600"><i data-lucide="clock" class="w-3 h-3"></i> Found ${timeAgo(lead.created_at)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-4 md:mt-0">
                        <button onclick="navigator.clipboard.writeText('Hey ${lead.project_name}, keep building!')" class="p-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-colors border border-white/5 hover:border-white/20"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        <a href="https://x.com/${lead.twitter_handle ? lead.twitter_handle.replace('@', '') : ''}" target="_blank" class="px-4 py-2 rounded-lg bg-primary/10 hover:bg-primary/20 text-primary border border-primary/20 hover:border-primary/40 transition-all font-medium text-sm">Open on X</a>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function timeAgo(dateString) {
            if (!dateString) return 'just now';
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>