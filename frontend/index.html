<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stratosphere Lead Engine</title>
    <link rel="icon" href="/assets/brand_logo.jpg" type="image/jpeg">

    <!-- Tailwinc CSS & Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8b5cf6',
                        accent: '#06b6d4',
                        background: '#09090b',
                        surface: '#18181b',
                        surfaceHighlight: '#27272a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            /* Deep Navy fallback */
            color: #fff;
            overflow-x: hidden;
            /* Animated Mesh Gradient Background */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: meshFlow 15s ease infinite;
        }

        @keyframes meshFlow {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Shining Card Effect - PREMIUM */
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            /* Increased Blur */
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* 10% Opacity Border */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        @keyframes snap-fade-in {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }
        }

        .snap-fade-in {
            animation: snap-fade-in 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .skeleton-pulse {
            animation: pulse-soft 1.5s infinite ease-in-out;
        }
    </style>
</head>

<body class="min-h-screen text-gray-200 selection:bg-violet-500 selection:text-white pb-32 md:pb-0 overflow-x-hidden">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-24 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <!-- Ambient Orbs -->
    <div
        class="fixed top-0 left-[-20%] w-[800px] h-[800px] bg-violet-600/10 rounded-full blur-[128px] pointer-events-none animate-pulse-soft">
    </div>
    <div
        class="fixed bottom-0 right-[-20%] w-[600px] h-[600px] bg-indigo-900/20 rounded-full blur-[128px] pointer-events-none">
    </div>

    <div class="max-w-7xl mx-auto px-4 md:px-6 relative z-10 pt-4 md:pt-8">

        <!-- UNIFIED GLASS HEADER -->
        <header
            class="glass-panel rounded-2xl p-5 md:p-6 mb-8 flex flex-col md:flex-row items-center justify-between gap-6 shadow-2xl border-white/5 relative overflow-hidden group">

            <!-- Shine Effect -->
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:animate-[shine_1.5s_ease-in-out_infinite]"
                style="animation-play-state: paused;"></div>

            <!-- Brand Section -->
            <div class="flex flex-col md:flex-row items-center gap-6 text-center md:text-left z-10">
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-2xl blur opacity-30 group-hover:opacity-60 transition duration-500">
                    </div>
                    <img id="logo-img" src="/assets/brand_logo.jpg" alt="Logo"
                        class="relative w-24 h-24 rounded-2xl shadow-2xl object-cover border border-white/10 ring-1 ring-white/5">
                </div>

                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight mb-2 drop-shadow-lg">
                        Stratosphere <span
                            class="text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-indigo-300 font-light">Radar</span>
                    </h1>
                    <div class="flex flex-wrap justify-center md:justify-start gap-2">
                        <span
                            class="px-3 py-1 rounded-full text-xs font-bold bg-violet-500/10 text-violet-200 border border-violet-500/20 shadow-inner shadow-violet-500/5">v3.5
                            Active</span>

                        <!-- Status Badge with ID restored for JS -->
                        <div
                            class="flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-inner shadow-emerald-500/5">
                            <span id="status-indicator"
                                class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_10px_currentColor]"></span>
                            <span id="status-text">System Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Cluster -->
            <div class="flex flex-wrap justify-center items-center gap-3 w-full md:w-auto z-10">
                <div id="loading-indicator"
                    class="hidden flex items-center gap-2 px-4 py-2 rounded-full bg-black/40 border border-white/10 backdrop-blur-md">
                    <div class="w-4 h-4 border-2 border-violet-400 border-t-transparent rounded-full animate-spin">
                    </div>
                    <span id="loading-text" class="text-xs font-medium text-violet-200">Processing...</span>
                </div>

                <button onclick="stopPipeline()" id="btn-stop"
                    class="hidden px-5 py-2.5 rounded-xl text-xs font-bold text-red-200 bg-red-500/20 border border-red-500/30 hover:bg-red-500/30 transition-all shadow-[0_0_15px_rgba(239,68,68,0.2)]">STOP
                    SYSTEM</button>

                <div class="flex items-center gap-2 mr-3 border-r border-white/10 pr-3 h-8">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="auto-pilot-toggle" class="peer sr-only">
                        <div
                            class="w-9 h-5 bg-white/10 rounded-full peer-checked:bg-emerald-500 transition-all relative shadow-inner">
                            <div
                                class="absolute top-1 left-1 w-3 h-3 bg-gray-300 rounded-full transition-all peer-checked:translate-x-4 peer-checked:bg-white shadow">
                            </div>
                        </div>
                        <span
                            class="text-[10px] font-bold text-gray-400 peer-checked:text-emerald-300 transition-colors uppercase tracking-wider group-hover:text-white flex items-center gap-1"><i
                                data-lucide="plane" class="w-3 h-3"></i> Auto-Pilot</span>
                    </label>
                </div>

                <button onclick="window.open('/leads/export?run_id=' + (currentRunId || ''), '_blank')"
                    class="p-3.5 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 hover:scale-105 active:scale-95 transition-all text-gray-400 hover:text-white group"
                    title="Export CSV">
                    <i data-lucide="download" class="w-5 h-5 group-hover:text-violet-300 transition-colors"></i>
                </button>

                <button id="btn-generate" onclick="handleGenerate()"
                    class="relative group px-10 py-3.5 rounded-xl bg-white text-black font-bold text-sm shadow-[0_0_20px_rgba(255,255,255,0.2)] hover:shadow-[0_0_40px_rgba(124,58,237,0.4)] transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden w-full md:w-auto">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        <i data-lucide="radar"
                            class="w-5 h-5 text-violet-600 transition-transform group-hover:rotate-180"></i>
                        INITIATE SCAN
                    </span>
                    <div
                        class="absolute inset-0 bg-gradient-to-r from-violet-100 via-white to-violet-100 opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <!-- Ripple effect container -->
                    <div class="absolute inset-0 pointer-events-none group-hover:animate-pulse bg-violet-500/10"></div>
                </button>
            </div>
        </header>

        <!-- KPI STATS (Vertical Stack Mobile) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Total -->
            <div class="glass-card p-6 md:p-8 rounded-2xl flex items-center justify-between group cursor-default">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em] mb-2">Discovered</h3>
                    <h2 id="stat-total"
                        class="text-5xl md:text-6xl font-bold text-white group-hover:text-violet-300 transition-colors drop-shadow-md">
                        0</h2>
                </div>
                <div
                    class="p-5 rounded-2xl bg-violet-500/10 text-violet-400 group-hover:scale-110 group-hover:bg-violet-500/20 group-hover:shadow-[0_0_30px_rgba(139,92,246,0.3)] transition-all duration-500">
                    <i data-lucide="database" class="w-8 h-8 md:w-10 md:h-10"></i>
                </div>
            </div>

            <!-- Ready -->
            <div class="glass-card p-6 md:p-8 rounded-2xl flex items-center justify-between group cursor-default">
                <div>
                    <h3 class="text-xs font-bold text-emerald-500/60 uppercase tracking-[0.2em] mb-2">Ready to DM</h3>
                    <h2 id="stat-ready"
                        class="text-5xl md:text-6xl font-bold text-white group-hover:text-emerald-300 transition-colors drop-shadow-md">
                        0</h2>
                </div>
                <div
                    class="p-5 rounded-2xl bg-emerald-500/10 text-emerald-400 group-hover:scale-110 group-hover:bg-emerald-500/20 group-hover:shadow-[0_0_30px_rgba(16,185,129,0.3)] transition-all duration-500">
                    <i data-lucide="send" class="w-8 h-8 md:w-10 md:h-10"></i>
                </div>
            </div>

            <!-- AI -->
            <div class="glass-card p-6 md:p-8 rounded-2xl flex items-center justify-between group cursor-default">
                <div>
                    <h3 class="text-xs font-bold text-amber-500/60 uppercase tracking-[0.2em] mb-2">AI Analyst</h3>
                    <h2 id="stat-alt"
                        class="text-5xl md:text-6xl font-bold text-white group-hover:text-amber-300 transition-colors drop-shadow-md">
                        0</h2>
                </div>
                <div
                    class="p-5 rounded-2xl bg-amber-500/10 text-amber-400 group-hover:scale-110 group-hover:bg-amber-500/20 group-hover:shadow-[0_0_30px_rgba(245,158,11,0.3)] transition-all duration-500">
                    <i data-lucide="bot" class="w-8 h-8 md:w-10 md:h-10"></i>
                </div>
            </div>
        </div>

        <!-- MAIN FEED -->
        <div
            class="glass-panel rounded-2xl flex flex-col h-[calc(100vh-480px)] min-h-[500px] border-t border-white/10 shadow-2xl relative overflow-hidden">
            <!-- Feed Headers -->
            <div
                class="p-5 border-b border-white/5 flex flex-col md:flex-row md:items-center justify-between gap-4 shrink-0 bg-black/20 backdrop-blur-xl z-20">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-white flex items-center gap-3">
                        <i data-lucide="list-filter" class="w-5 h-5 text-violet-400"></i> Lead Stream
                    </h3>

                    <div id="progress-container"
                        class="hidden w-32 h-1.5 bg-gray-800 rounded-full overflow-hidden shadow-inner">
                        <div id="progress-bar"
                            class="h-full bg-gradient-to-r from-violet-600 to-indigo-400 transition-all duration-500 w-0">
                        </div>
                    </div>
                </div>

                <div
                    class="flex p-1 bg-black/40 rounded-xl border border-white/5 overflow-x-auto no-scrollbar shadow-inner">
                    <button onclick="setFilter('READY_TO_DM')" id="tab-ready"
                        class="flex-1 whitespace-nowrap px-5 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-white transition-colors uppercase tracking-wider">Ready
                        to DM</button>
                    <button onclick="setFilter('NEEDS_ALT_OUTREACH')" id="tab-ai"
                        class="flex-1 whitespace-nowrap px-5 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-white transition-colors uppercase tracking-wider">AI
                        Required</button>
                    <button onclick="setFilter('')" id="tab-all"
                        class="flex-1 whitespace-nowrap px-5 py-2 text-xs font-bold rounded-lg bg-violet-600 text-white shadow-[0_0_15px_rgba(124,58,237,0.4)] transition-all uppercase tracking-wider">All
                        Signals</button>
                </div>
            </div>

            <!-- Feed Content -->
            <div id="lead-list" class="flex-1 overflow-y-auto p-5 space-y-3 scroll-smooth no-scrollbar">
                <!-- LEADS WILL RENDER HERE -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://stratosphereleads.up.railway.app";
        let isRunning = false;
        let pollingInterval = null;
        let currentFilter = '';
        let currentRunId = null;

        const $ = (id) => document.getElementById(id);
        const setVal = (id, val) => { const el = $(id); if (el) el.textContent = val; };
        const setHtml = (id, html) => { const el = $(id); if (el) el.innerHTML = html; };
        const setClass = (id, cls) => { const el = $(id); if (el) el.className = cls; };
        const show = (id) => { const el = $(id); if (el) el.classList.remove('hidden'); };
        const hide = (id) => { const el = $(id); if (el) el.classList.add('hidden'); };

        // --- TOAST SYSTEM ---
        function showToast(msg, type = 'info') {
            const container = $('toast-container');
            if (!container) return;

            const el = document.createElement('div');
            el.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl backdrop-blur-md shadow-2xl border transition-all duration-300 transform translate-x-10 opacity-0 ${type === 'error' ? 'bg-red-500/20 border-red-500/30 text-red-200' :
                type === 'success' ? 'bg-emerald-500/20 border-emerald-500/30 text-emerald-200' :
                    'bg-violet-500/20 border-violet-500/30 text-white'
                }`;

            let icon = type === 'error' ? 'alert-circle' : type === 'success' ? 'check-circle' : 'info';

            el.innerHTML = `
                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                        <span class="text-xs font-bold tracking-wide">${msg}</span>
                    `;

            container.appendChild(el);
            if (window.lucide) lucide.createIcons();

            // Animate In
            requestAnimationFrame(() => {
                el.classList.remove('translate-x-10', 'opacity-0');
            });

            // Remove
            setTimeout(() => {
                el.classList.add('translate-x-10', 'opacity-0');
                setTimeout(() => el.remove(), 300);
            }, 4000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) lucide.createIcons();
            const logo = $('logo-img');
            if (logo) logo.src = '/assets/brand_logo.jpg?v=' + new Date().getTime();
            const btn = $('btn-generate');
            if (btn) btn.onclick = handleGenerate;

            fetchData();
            startPolling();
        });

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function renderSkeletons() {
            const list = $('lead-list');
            if (!list) return;
            list.innerHTML = ''; // Clear

            // Generate 5 Skeletons
            let html = '';
            for (let i = 0; i < 5; i++) {
                html += `
                        <div class="p-5 rounded-2xl glass-card flex items-start gap-4 border border-white/5 relative overflow-hidden">
                             <div class="w-12 h-12 rounded-xl bg-white/5 skeleton-pulse shrink-0"></div>
                             <div class="flex-1 space-y-3">
                                <div class="flex justify-between">
                                    <div class="h-4 w-32 bg-white/5 rounded skeleton-pulse"></div>
                                    <div class="h-4 w-16 bg-white/5 rounded skeleton-pulse"></div>
                                </div>
                                <div class="h-3 w-3/4 bg-white/5 rounded skeleton-pulse"></div>
                                <div class="h-3 w-1/2 bg-white/5 rounded skeleton-pulse"></div>
                             </div>
                        </div>`;
            }
            list.innerHTML = html;
        }

        async function handleGenerate() {
            if (isRunning) return;

            // Check Auto-Pilot
            const autoPilotToggle = $('auto-pilot-toggle');
            const isAuto = autoPilotToggle ? autoPilotToggle.checked : false;

            setLoadingState(true, isAuto ? "Auto-Pilot: Initializing..." : "Radar Active: Initializing...");
            currentRunId = generateUUID();

            renderSkeletons(); // SHOW SKELETONS

            try {
                const modeSelect = $('run-mode');
                const mode = modeSelect ? modeSelect.value : 'fresh';

                const res = await fetch(`${API_URL}/pipeline/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode, run_id: currentRunId, auto_pilot: isAuto })
                });

                if (!res.ok) throw new Error("Server refused connection");

                const data = await res.json();
                if (data.status === 'busy') {
                    showToast("System is busy. Please wait.", "error");
                } else {
                    const bar = $('progress-bar');
                    if (bar) bar.style.width = '5%';
                    startPolling();
                }
            } catch (e) {
                showToast(`Start Failed: ${e.message}`, "error");
                setLoadingState(false);
                fetchData();
            }
        }

        // ... stopPipeline (keep same but use toast) ...

        async function stopPipeline() {
            if (!confirm("Confirm Emergency Stop?")) return;
            try {
                await fetch(`${API_URL}/pipeline/stop`, { method: 'POST' });
                const btn = $('btn-stop');
                if (btn) btn.textContent = "Halting...";
                showToast("Emergency Stop Initiated", "info");

                setTimeout(() => {
                    setLoadingState(false);
                    fetchData();
                }, 2000);
            } catch (e) {
                showToast("Stop Failed: " + e.message, "error");
            }
        }

        // ... setFilter ...

        function setFilter(bucket) {
            currentFilter = bucket;
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.className = "flex-1 whitespace-nowrap px-5 py-2 text-xs font-bold rounded-lg text-gray-400 hover:text-white transition-colors uppercase tracking-wider";
            });
            let activeId = 'tab-all';
            if (bucket === 'READY_TO_DM') activeId = 'tab-ready';
            if (bucket === 'NEEDS_ALT_OUTREACH') activeId = 'tab-ai';
            const activeBtn = $(activeId);
            if (activeBtn) {
                activeBtn.className = "flex-1 whitespace-nowrap px-5 py-2 text-xs font-bold rounded-lg bg-violet-600 text-white shadow-[0_0_15px_rgba(124,58,237,0.4)] transition-all uppercase tracking-wider";
            }
            fetchData();
        }

        function startPolling() {
            if (pollingInterval) return;
            pollStatus();
            pollingInterval = setInterval(pollStatus, 2000);
            setInterval(() => { if (!isRunning) fetchData(); }, 30000);
        }

        async function pollStatus() {
            try {
                const res = await fetch(`${API_URL}/pipeline/status`);
                if (!res.ok) return;
                const state = await res.json();
                renderStatus(state);

                const bar = $('progress-bar');

                if (state.state === 'running') {
                    if (!isRunning) setLoadingState(true, state.current_step || "Radar Active");
                    show('progress-container');
                    if (bar) bar.style.width = `${state.progress}%`;

                    // Dynamic Header Text Upgrade
                    setVal('loading-text', state.current_step ? state.current_step.replace("Mining", "Scanning") : "Processing...");

                    updateStats(state);
                } else {
                    if (isRunning) {
                        setLoadingState(false);
                        hide('progress-container');
                        if (bar) bar.style.width = '0%';
                        fetchData();
                        if (state.state === 'error') {
                            showToast("Engine Alert: " + state.current_step, "error");
                        } else {
                            showToast("Scan Complete. Database Updated.", "success");
                        }
                    }
                }
            } catch (e) {
                // Silent
            }
        }

        function renderStatus(state) {
            // ... keep existing renderStatus ...
            const statusEl = $('status-text');
            const indicator = $('status-indicator');
            if (!statusEl || !indicator) return;

            let text = "Idle";
            let colorClass = "text-gray-400";
            let dotClass = "bg-gray-500 shadow-none";

            switch (state.state) {
                case "running":
                    text = state.current_step ? state.current_step.split('(')[0] : "ACTIVE"; // Simplified
                    colorClass = "text-emerald-400 font-bold";
                    dotClass = "bg-emerald-400 shadow-[0_0_10px_currentColor]";
                    break;
                case "error":
                    text = "OFFLINE";
                    colorClass = "text-red-400 font-bold";
                    dotClass = "bg-red-500 shadow-[0_0_10px_currentColor]";
                    break;
                case "done":
                    text = "ONLINE";
                    colorClass = "text-emerald-300 font-medium";
                    dotClass = "bg-emerald-500 shadow-[0_0_10px_currentColor]";
                    break;
            }
            statusEl.textContent = text;
            statusEl.className = `text-[10px] uppercase tracking-wider ${colorClass}`;
            indicator.className = `w-2 h-2 rounded-full animate-pulse transition-all duration-300 ${dotClass}`;
        }

        async function fetchData() {
            try {
                const timeEl = $('last-updated');
                if (timeEl) timeEl.textContent = "Updated: " + new Date().toLocaleTimeString();

                fetch(`${API_URL}/api/leads/stats`)
                    .then(res => res.json())
                    .then(stats => updateStats(stats))
                    .catch(e => { });

                let url = `${API_URL}/api/leads?limit=500`;
                if (currentFilter && currentFilter.length > 0) url += `&bucket=${currentFilter}`;

                const leadsRes = await fetch(url);
                if (!leadsRes.ok) throw new Error("Signal Lost");

                const leads = await leadsRes.json();
                renderLeads(leads);
            } catch (e) {
                showToast("Reconnecting to satellite...", "info"); // Cleaner error
            }
        }

        function updateStats(stats) {
            const anim = (id, val) => {
                const el = $(id);
                // Micro-interaction: Slide Up Effect implementation via simple rewrite for now
                if (el && el.textContent != val) animateValue(id, parseInt(el.textContent) || 0, val || 0, 800);
            };
            anim('stat-total', stats.total_leads);
            anim('stat-ready', stats.ready_to_dm);
            anim('stat-alt', stats.needs_alt_outreach);
        }

        // ... Keep setLoadingState ...
        function setLoadingState(loading, text = "Processing...") {
            const btn = $('btn-generate');
            const stopBtn = $('btn-stop');

            isRunning = loading;

            if (loading) {
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                }
                show('loading-indicator');
                show('btn-stop');
                setVal('loading-text', text);
            } else {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                }
                hide('loading-indicator');
                hide('btn-stop');
            }
        }


        async function analyzeLead(id, btn) {
            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Analyzing...`;
            if (window.lucide) lucide.createIcons();

            try {
                const res = await fetch(`${API_URL}/api/leads/${id}/analyze`, { method: 'POST' });
                if (!res.ok) throw new Error("Analysis failed");
                const data = await res.json();

                // Success: Refresh data to show result
                // But for instant feedback, let's find the card and inject it
                const card = document.querySelector(`div[data-id="${id}"]`);
                if (card) {
                    const resultContainer = card.querySelector('.analysis-result');
                    if (resultContainer) {
                        resultContainer.innerHTML = renderAnalysisBlock(data);
                        resultContainer.classList.remove('hidden');
                        btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Done`;
                    }
                }
                setTimeout(() => fetchData(), 1500); // Full refresh to sync state

            } catch (e) {
                showToast(e.message, "error");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function updateStatus(id, status, bucket) {
            try {
                const res = await fetch(`${API_URL}/api/leads/${id}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, bucket })
                });
                if (!res.ok) throw new Error("Update failed");
                showToast(`Lead marked as ${status}`, "success");
                fetchData(); // Refresh UI
            } catch (e) {
                showToast(e.message, "error");
            }
        }

        function openDM(handle, text) {
            if (!handle) return showToast("No Twitter handle found", "error");
            navigator.clipboard.writeText(text).then(() => {
                showToast("Icebreaker Copied! Opening Profile...", "success");
                window.open(`https://twitter.com/${handle.replace('@', '')}`, '_blank');
            });
        }

        function renderAnalysisBlock(lead) {
            if (!lead.ai_analysis) return '';

            const analysisHtml = lead.ai_analysis.split('\n').map(line => `<div class="mb-1">${line}</div>`).join('');

            // Escape special chars for the onclick handler
            const safeIcebreaker = (lead.icebreaker || "").replace(/'/g, "\\'").replace(/\n/g, " ");

            return `
                <div class="mt-4 p-4 rounded-xl bg-violet-500/10 border border-violet-500/20 text-xs text-violet-200">
                    <h4 class="font-bold text-violet-300 mb-2 flex items-center gap-2"><i data-lucide="sparkles" class="w-3 h-3"></i> AI Analysis</h4>
                    <div class="space-y-1 opacity-90 leading-relaxed mb-3">${analysisHtml}</div>
                    
                    ${lead.icebreaker ? `
                    <div class="mt-3 pt-3 border-t border-violet-500/20">
                        <h4 class="font-bold text-violet-300 mb-1 flex items-center gap-2"><i data-lucide="message-square" class="w-3 h-3"></i> Suggested Opener</h4>
                        <div class="p-3 rounded-lg bg-black/20 text-gray-300 font-mono select-all cursor-pointer hover:bg-black/30 transition-colors" title="Click to Copy" onclick="navigator.clipboard.writeText(this.innerText); showToast('Copied to clipboard', 'success')">${lead.icebreaker}</div>
                    </div>` : ''}

                    <!-- ENRICHMENT DATA -->
                    ${(lead.email || lead.telegram_url || lead.discord_url) ? `
                    <div class="mt-3 pt-3 border-t border-white/5 grid grid-cols-2 gap-2">
                        ${lead.email ? `<a href="mailto:${lead.email}" class="flex items-center gap-2 p-2 rounded bg-white/5 hover:bg-white/10 text-gray-300 text-[10px] font-mono transition-colors"><i data-lucide="mail" class="w-3 h-3 text-emerald-400"></i> ${lead.email}</a>` : ''}
                        ${lead.telegram_url ? `<a href="${lead.telegram_url}" target="_blank" class="flex items-center gap-2 p-2 rounded bg-blue-500/10 hover:bg-blue-500/20 text-blue-300 text-[10px] font-bold transition-colors"><i data-lucide="send" class="w-3 h-3"></i> Join Telegram</a>` : ''}
                        ${lead.discord_url ? `<a href="${lead.discord_url}" target="_blank" class="flex items-center gap-2 p-2 rounded bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-300 text-[10px] font-bold transition-colors"><i data-lucide="message-circle" class="w-3 h-3"></i> Join Discord</a>` : ''}
                    </div>` : ''}

                    <!-- CRM ACTION BAR -->
                    <div class="mt-4 flex items-center gap-2 border-t border-white/5 pt-3">
                         <button onclick="openDM('${lead.twitter_handle || ''}', '${safeIcebreaker}'); updateStatus(${lead.id}, 'Contacted', 'CONTACTED')" class="flex-1 px-3 py-2 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 cursor-pointer shadow-lg shadow-white/5">
                             <i data-lucide="send" class="w-3 h-3"></i> Send DM
                         </button>
                         <button onclick="updateStatus(${lead.id}, 'Qualified', 'READY_TO_DM')" class="px-3 py-2 bg-emerald-500/20 text-emerald-300 font-bold rounded-lg hover:bg-emerald-500/30 transition-colors border border-emerald-500/30" title="Qualify Lead">
                             <i data-lucide="check" class="w-4 h-4"></i>
                         </button>
                         <button onclick="updateStatus(${lead.id}, 'Archived', 'ARCHIVED')" class="px-3 py-2 bg-red-500/20 text-red-300 font-bold rounded-lg hover:bg-red-500/30 transition-colors border border-red-500/30" title="Archive Lead">
                             <i data-lucide="trash-2" class="w-4 h-4"></i>
                         </button>
                    </div>
                </div>
            `;
        }

        // renderLeads (modified)
        function renderLeads(leads) {
            const list = $('lead-list');
            if (!list) return;

            if (!leads || leads.length === 0) {
                renderSkeletons();
                return;
            }

            const existingMap = new Map();
            list.querySelectorAll('[data-id]').forEach(el => existingMap.set(parseInt(el.dataset.id), el));

            leads.forEach((lead, index) => {
                let el = existingMap.get(lead.id);
                let isNew = false;
                if (!el) {
                    isNew = true;
                    el = document.createElement('div');
                    el.dataset.id = lead.id;
                    el.className = `w-full p-5 rounded-2xl glass-card flex items-start gap-4 group hover:bg-white/5 transition-all relative overflow-hidden`;
                    el.classList.add('opacity-0', 'snap-fade-in');
                    el.style.animationDelay = `${Math.min(index * 0.05, 1.0)}s`;
                }

                const isHot = (lead.score || 0) > 40;
                if (isHot) el.classList.add('border-orange-500/20', 'bg-orange-500/5');
                else el.classList.remove('border-orange-500/20', 'bg-orange-500/5');

                let chains = [];
                try { chains = JSON.parse(lead.chains || '[]'); } catch (e) { if (lead.chains) chains = [lead.chains]; }

                let tags = [];
                try { tags = JSON.parse(lead.tags || '[]'); } catch (e) { if (lead.tags) tags = [lead.tags]; }

                let badges = '';

                // TELEGRAM PRIORITY BADGE
                if (lead.telegram_channel || lead.telegram_url) {
                    badges += `<a href="${lead.telegram_url || '#'}" target="_blank" class="bg-blue-500/10 text-blue-400 border border-blue-500/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(59,130,246,0.1)] hover:bg-blue-500/20 transition-colors flex items-center gap-1"><i data-lucide="send" class="w-3 h-3"></i> Telegram</a>`;
                }

                if (lead.bucket === 'READY_TO_DM') {
                    badges += `<span class="bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(16,185,129,0.1)]">Ready</span>`;
                } else if (lead.ai_analysis) {
                    badges += `<span class="bg-violet-500/10 text-violet-400 border border-violet-500/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider shadow-[0_0_10px_rgba(139,92,246,0.1)]">Analyzed</span>`;
                }

                // Chain Badges
                chains.slice(0, 2).forEach(c => {
                    badges += `<span class="bg-gray-700/50 text-gray-300 border border-gray-600 px-1.5 py-0.5 rounded text-[9px] font-mono tracking-wide">${c}</span>`;
                });

                if (isHot) {
                    badges = `<span class="bg-orange-500/10 text-orange-400 border border-orange-500/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><i data-lucide="flame" class="w-3 h-3"></i> ${lead.score}</span>` + badges;
                }

                const handle = lead.twitter_handle ? lead.twitter_handle.replace('@', '') : '';
                const pfp = lead.profile_image_url || (handle ? `https://unavatar.io/twitter/${handle}` : `https://ui-avatars.com/api/?name=${lead.project_name}&background=1e293b&color=fff`);
                let desc = (lead.description || "No description available.").replace(/["{}]/g, "");

                // Launch Date
                let launchBadge = '';
                if (lead.launch_date) {
                    const d = new Date(lead.launch_date);
                    launchBadge = `<span class="text-[9px] font-mono text-gray-500 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${d.toLocaleDateString()}</span>`;
                }

                const analysisBlock = renderAnalysisBlock(lead);

                const html = `
                            <div class="relative w-12 h-12 shrink-0 group-hover:scale-105 transition-transform duration-500 ease-out">
                                <img src="${pfp}" alt="Icon" class="w-full h-full rounded-xl object-cover border border-white/10 shadow-lg bg-gray-900" loading="lazy" onerror="this.src='https://ui-avatars.com/api/?name=?'">
                                ${lead.platform === 'x' ? '<div class="absolute -bottom-1 -right-1 w-5 h-5 bg-black rounded-full flex items-center justify-center border border-gray-800"><i data-lucide="twitter" class="w-3 h-3 text-white"></i></div>' : ''}
                            </div>
                            
                            <div class="flex-1 min-w-0 z-10">
                                <div class="flex items-center justify-between mb-1.5">
                                    <h3 class="font-bold text-white text-base truncate pr-2 group-hover:text-violet-300 transition-colors">${lead.project_name}</h3>
                                    <div class="flex items-center gap-2 shrink-0">${badges}</div>
                                </div>
                                
                                <p class="text-xs text-gray-400 line-clamp-2 leading-relaxed font-mono opacity-80 group-hover:opacity-100 transition-opacity mb-3">${desc}</p>
                                
                                <div class="flex items-center gap-3 opacity-60 group-hover:opacity-100 transition-opacity duration-300">
                                     ${lead.domain ? `<a href="${lead.domain}" target="_blank" class="text-[10px] font-bold text-white hover:text-violet-300 flex items-center gap-1"><i data-lucide="globe" class="w-3 h-3"></i> Web</a>` : ''}
                                     ${handle ? `<a href="https://twitter.com/${handle}" target="_blank" class="text-[10px] font-bold text-[#1DA1F2] hover:text-white flex items-center gap-1"><i data-lucide="twitter" class="w-3 h-3"></i> @${handle}</a>` : ''}
                                     ${launchBadge}
                                     <span class="ml-auto text-[10px] text-gray-600 font-mono">${timeAgo(lead.created_at)}</span>
                                     
                                     <!-- Analyze Button -->
                                     ${!lead.ai_analysis ?
                        `<button onclick="analyzeLead(${lead.id}, this)" class="ml-2 px-3 py-1 bg-violet-600/20 hover:bg-violet-600 text-violet-300 hover:text-white text-[10px] font-bold uppercase rounded-md transition-all flex items-center gap-1 shadow-[0_0_10px_rgba(124,58,237,0.1)] hover:shadow-[0_0_15px_rgba(124,58,237,0.5)]">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Analyze
                                      </button>` : ''}
                                </div>
                                
                                <!-- Analysis Result Injection Point -->
                                <div class="analysis-result ${lead.ai_analysis ? '' : 'hidden'}">
                                     ${analysisBlock}
                                </div>
                            </div>
                        `;

                if (el.innerHTML !== html) el.innerHTML = html;
                if (isNew) list.appendChild(el);
            });
            const currentIds = new Set(leads.map(l => l.id));
            existingMap.forEach((el, id) => {
                if (!currentIds.has(id)) el.remove();
            });
            if (window.lucide) lucide.createIcons();
        }

        function timeAgo(dateString) {
            if (!dateString) return '';
            const sec = Math.floor((new Date() - new Date(dateString)) / 1000);
            if (sec < 60) return 'now';
            if (sec < 3600) return Math.floor(sec / 60) + 'm';
            if (sec < 86400) return Math.floor(sec / 3600) + 'h';
            return Math.floor(sec / 86400) + 'd';
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = $(id);
            if (!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
    </script>
</body>

</html>